<!DOCTYPE html>
<html>

  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Covid App - Map</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <style>
      .map-responsive {
        overflow: hidden;
        padding-bottom: 50%;
        position: relative;
        height: 0;
      }

      .map-responsive iframe {
        left: 0;
        top: 0;
        height: 100%;
        width: 100%;
        position: absolute;
      }

      #visible-markers {
        max-height: 700px;
        margin-bottom: 10px;
        overflow: scroll;
        -webkit-overflow-scrolling: touch;
      }

    </style>
  </head>

  <body>
    <div class="container-fluid">
      <div id="floating-controls" class="row">
        <input class="col-sm" onclick="filterVisiblity();" type=button value="Clear Filters"
          style="background-color: #fff;">
        <input class="col-sm" onclick="filterVisiblity('food');" type=button value="Food"
          style="background-color: #DB4437;">
        <input class="col-sm" onclick="filterVisiblity('supplies');" type=button value="Supplies"
          style="background-color: #0F9D58;">
        <input class="col-sm" onclick="filterVisiblity('aid');" type=button value="Aid"
          style="background-color: #F4B400;">
        <input class="col-sm" onclick="filterVisiblity('mobility');" type=button value="Mobility"
          style="background-color: #4285F4;">
      </div>
      <div class="row">
        <div id="map" class="col-9 map-responsive"></div>
        <div id="visible-markers" class="col-3 list-group list-group-flush">

        </div>
      </div>
    </div>

    <script>
      var markers = []
      var serviceCircles = []
      var markerCluster = null

      // Filter markers by service type
      function filterVisiblity(filter) {
        markers.forEach(function (marker) {

          if (filter) {
            // If filtering only set the markers that match to true
            var services = marker.title.split(',')
            var visiblity = services.indexOf(filter) !== -1
            marker.setVisible(visiblity);
          } else {
            // If no filter set to true
            marker.setVisible(true);
          }


        })

        markerCluster.repaint ? markerCluster.repaint() : null
      }

      function initMap(filter) {
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 3,
          center: { lat: -28.024, lng: 140.887 },
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          streetViewControl: false,
          clickableIcons: false,
          mapTypeControl: false

        });

        var infoWindows = Object.values(locations)
          .map(function (location) {
            var contentString = '<div id="content">' +
              '<div id="siteNotice">' +
              '</div>' +
              '<h1 id="firstHeading" class="firstHeading">' + location.contentTitle + '</h1>' +
              '<div id="bodyContent">' +
              location.contentBody +
              '</div>' +
              '<div>' +
              '<hr>' +
              '<p>Email: <a href="mailto:' + location.contact.email + '">' + location.contact.email + '</a></p>' +
              '<p>Phone: <a href="tel:' + location.contact.number + '">' + location.contact.number + '</a></p>' +
              '<div>' +
              '</div>';

            return new google.maps.InfoWindow({
              content: contentString
            })
          })

        markers = Object.values(locations)
          .map(function (location, i) {
            var marker = new google.maps.Marker({
              position: location,
              label: location.label,
              title: location.types.join(',')
            });

            marker.addListener('click', function () {
              infoWindows[i].open(map, marker);
            });


            marker.addListener('title_changed', function () {
              if (!marker.getVisible()) {
                return;
              }

              var color;
              var services = marker.title.split(',')
              if (services.indexOf('mobility') !== -1) {
                color = '#4285F4'
              } else if (services.indexOf('food') !== -1) {
                color = '#DB4437'
              } else if (services.indexOf('supplies') !== -1) {
                color = '#0F9D58'
              } else {
                color = '#F4B400'
              }

              // Only push this if Radius is less than current radius
              // TODO: Write the above code
              serviceCircles.push(new google.maps.Circle({
                strokeColor: color,
                strokeOpacity: 0.3,
                strokeWeight: 1,
                fillColor: color,
                fillOpacity: 0.15,
                map: map,
                center: marker.position,
                radius: locations[marker.getLabel()].serviceRadius
              }));
              // Issue: Product is too dark at zoom levels
              // Solution: Else use this to create a border color change on the map
              // Increase the stroke logrithmically to a max
              // TODO: Write the above
            });

            return marker;
          });

        // Add a marker clusterer to manage the markers.
        markerCluster = new MarkerClusterer(map, markers, {
          imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
          ignoreHidden: true,
          averageCenter: true,
          gridSize: 30
        });

        markerCluster.addListener('clusteringbegin', function (mc) {
          serviceCircles.forEach(function (circle) {
            // Check this first since not everything we out in here is a useful (aka may include nulls due to previous business logic)
            if (circle.setMap) {
              circle.setMap(null);
            }
          })

          // Clear it to save space (even as an array of nulls)
          serviceCircles = [];
        })

        markerCluster.addListener('clusteringend', function (mc) {
          var visibleMarkers = [];
          mc.getClusters().forEach(function (cluster) {
            if (cluster.getSize() === 1) {
              var singleMarker = cluster.getMarkers()[0]
              singleMarker.setTitle(singleMarker.getTitle()) // Trigger Radius Drawing
              visibleMarkers.push(singleMarker);
            } else {
              var maxMarkerRadius = 0;
              var maxMarker;
              cluster.getMarkers().forEach(function (singleMarker) {
                // Update maxMarker to higher value if found.
                var newPotentialMaxMarkerRadius = Math.max(maxMarkerRadius, locations[singleMarker.label].serviceRadius);
                maxMarker = newPotentialMaxMarkerRadius > maxMarkerRadius ? singleMarker : maxMarker
                visibleMarkers.push(singleMarker); // Register it so we can clear or manipulate it later
              })
              if (maxMarker) {
                maxMarker.setTitle(maxMarker.getTitle()) // Trigger Radius Drawing on max radius marker for the cluster
              }
            }
          });
          var newListContent = ''
          visibleMarkers.forEach(function (marker) {
            var location = locations[marker.getLabel()]
            newListContent +=
              '<a href="#" class="list-group-item list-group-item-action flex-column align-items-start">' +
              '<div class="d-flex w-100 justify-content-between">' +
              '<h5 class="mb-1">' + location.contentTitle + '</h5>' +
              '<small class="text-muted">' + location.types.join(', ') + '</small>' +
              '</div >' +
              '<p class="mb-1">' + location.contentBody + '</p>' +
              '</a >'
          })

          if (!newListContent) {
            newListContent = '<a href="#" class="list-group-item list-group-item-action flex-column align-items-start">' +
              '<div class="d-flex w-100 justify-content-between">' +
              '<h5 class="mb-1">No Locations Found</h5>' +
              '</div >' +
              '<p class="mb-1">Try looking at a different area of the map</p>' +
              '</a >'
          }
          var listDiv = $("#visible-markers").html(newListContent);
        })
      }
      var locations = {
        '1': { lat: -31.563910, lng: 147.154312, label: '1', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['food', 'supplies', 'aid'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '2': { lat: -33.718234, lng: 150.363181, label: '2', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['food', 'aid'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '3': { lat: -33.727111, lng: 150.371124, label: '3', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['food', 'supplies'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '4': { lat: -33.848588, lng: 151.209834, label: '4', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['food', 'aid'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '5': { lat: -33.851702, lng: 151.216968, label: '5', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['supplies', 'aid'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '6': { lat: -34.671264, lng: 150.863657, label: '6', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['food'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '7': { lat: -35.304724, lng: 148.662905, label: '7', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['supplies', 'aid'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '8': { lat: -36.817685, lng: 175.699196, label: '8', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['food', 'aid'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '9': { lat: -36.828611, lng: 175.790222, label: '9', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['food', 'supplies', 'aid'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '10': { lat: -37.750000, lng: 145.116667, label: '10', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['aid'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '11': { lat: -37.759859, lng: 145.128708, label: '11', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['aid'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '12': { lat: -37.765015, lng: 145.133858, label: '12', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['food'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '13': { lat: -37.770104, lng: 145.143299, label: '13', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['aid'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '14': { lat: -37.773700, lng: 145.145187, label: '14', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['supplies'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '15': { lat: -37.774785, lng: 145.137978, label: '15', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['food'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '16': { lat: -37.819616, lng: 144.968119, label: '16', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['aid'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '17': { lat: -38.330766, lng: 144.695692, label: '17', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['food'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '18': { lat: -39.927193, lng: 175.053218, label: '18', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['food', 'supplies', 'aid'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '19': { lat: -41.330162, lng: 174.865694, label: '19', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['aid'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '20': { lat: -42.734358, lng: 147.439506, label: '20', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['food', 'aid'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '21': { lat: -42.734358, lng: 147.501315, label: '21', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['aid'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '22': { lat: -42.735258, lng: 147.438000, label: '22', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['food'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
        '23': { lat: -43.999792, lng: 170.463352, label: '23', contentTitle: 'Bob\'s Supplies', contentBody: '<p>This is the <strong>HTML</strong> content</p>', types: ['mobility'], contact: { number: '+1 800 555 1234', email: 'email@email.com' }, serviceRadius: 24000 },
      }
    </script>
    <!-- Replace following script src -->
    <script src="https://unpkg.com/@google/markerclustererplus@4.0.1/dist/markerclustererplus.min.js"></script>
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD5ywRBOAoyjwic5SzT9q3MPjLT1aibHO8&callback=initMap">
      </script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
      integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
      crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
      integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
      crossorigin="anonymous"></script>
  </body>

</html>
